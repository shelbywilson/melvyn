<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="robots" content="index,follow" />
        <meta name="googlebot" content="index,follow" />
        <meta name="description" content="" />
        <meta property="og:url" content="h" />
        <meta property="og:title" content="in our time" />
        <meta property="og:description" content="" />
        <meta name="theme-color" content="#000">
        <title>in our time</title>
        <link rel="stylesheet" type="text/css" href="./main.css" />
        <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Official_portrait_of_Lord_Bragg_crop_2.jpg/440px-Official_portrait_of_Lord_Bragg_crop_2.jpg" />

        <style>
            .row {
                display: flex;
                padding: 1rem 0;
            }
            .row > div {
                padding: 1.5rem 1.5rem 1.5rem 0;
            }
            .row h3 {
                margin: 0 0 0.5rem 0;
            }
            .row .desc {
                flex: 0 0 35%;
            }
            .row .date {
                flex: 0 0 150px;
            }
            .expert:not(:first-child) {
                padding-top: 0.5rem;
            }
            .expert a {
                margin-left: 0.5rem;
            }

            @media screen and (max-width: 776px) {
                .row {
                    flex-direction: column;
                }
                .row > .desc, .row .date {
                    flex: 1 1 100%;
                }
            }
        </style>

        <script>
            let episodes = [];
            let bbcDescriptions = {};
            let guestFrequency = {};
            window.onload = () => {
                fetch('./data/bbc-descriptions.json')
                    .then(res => res.json())
                    .then(data => {
                        bbcDescriptions = data;
                    })
                    .then(() => {
                        fetch('./data/guest_frequency.json')
                            .then(res => res.json())
                            .then(data => {
                                guestFrequency = data;
                            })
                            .then(() => {
                                fetch('./data/episodes.json')
                                    .then(res => res.json())
                                    .then(data => {
                                        episodes = data;

                                        display();
                                    })
                            })
                    })
            }
            function display() {
                episodes.forEach(ep => {
                    const el = document.createElement('div')
                    el.classList = ['row']
                    let experts = ''

                    ep.experts.forEach(expert => 
                        experts += `<div class="expert">
                            <strong>
                                ${expert.name}
                            </strong>
                            <a href="./guests/${expert.name.replace(/\s/g, '_')}.html">
                                ${guestFrequency[expert.name].count} ${guestFrequency[expert.name].count === 1 ? 'episode' : 'episodes'}
                            </a>
                        </div>
                        <div>
                            <em>${expert.title}</em>
                        </div>`
                    )

                    el.innerHTML = `
                        <div class="date">
                            ${ep.date}
                        </div>
                        <div class="desc">
                            <h3>
                                <a href="https://www.bbc.co.uk/sounds/play/${ep.episode_link.split('/').pop()}" target="_blank">
                                    ${ep.topic} &nearr;
                                </a>
                            </h3>
                            <p>
                                ${bbcDescriptions[ep.date + '_' + ep.topic].short_desc}
                            </p>
                            <div>
                                <a href="${ep.wiki_link}" target="_blank">
                                    wiki &nearr;
                                </a>
                            </div>
                        </div>
                        <div>
                            ${experts}
                        </div>
                    `;

                    document.body.querySelector('#episodes').append(el)
                })
            }
        </script>
    </head>
    <body>
        <main>
            <div>
                <h1>
                    Hello,
                </h1>
                <div id="episodes">
                </div>
            </div>
        </main>
    </body>
</html>